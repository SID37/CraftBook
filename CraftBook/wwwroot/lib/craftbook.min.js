var ErrorView=function(){function e(e){this.parent=e,this.view=document.createElement("div"),this.view.classList.add("error"),e.insertAdjacentElement("beforebegin",this.view),this.display(!1)}return e.prototype.display=function(e){this.view.style.display=e?("string"==typeof e&&(this.view.textContent=e),"initial"):"none"},e}(),ImageUploader=function(e,o,i){void 0===i&&(i="one");var s=new ErrorView(e);e.ondrop=function(e){var r=e.dataTransfer;if(r){if(0<r.files.length&&(e.preventDefault(),1<r.files.length&&"one"===i))return void s.display("Здесь можно загрузить только один файл!");console.group("files");for(var t=function(e){var t=r.files[e];if(t.type.match(/image/)){var n=new XMLHttpRequest;console.log("Отловили файл "+t.name),n.onloadend=function(){if(s.display(!1),300<n.status)s.display("Не удалось отправить картинку. Ошибка "+n.status+".");else{var e=JSON.parse(n.response);e.message?s.display(e.message):o(e.link)}},n.open("POST","/Images/Create",!0);var i=new FormData;i.append("image",t),n.send(i)}},n=0;n<r.files.length;n++)t(n);console.groupEnd()}}},ImageView=function(){function e(e,t){this.img=e,t&&this.setLink(t)}return e.prototype.setLink=function(e){this.img.src=e},e}(),IngredientModel=function(){},IngredientView=function(e){var t=this;this.delete=function(){t.button.onclick(null)},this.main=document.createElement("div"),this.main.classList.add("fieldform"),this.main.innerHTML='<span class="name"></span><span class="volume"></span><input type="image" name="del_ingredient" src="/images/ingredient/close.svg" />',this.button=this.main.querySelector('input[type="image"'),this.button.onclick=function(){return t.main.remove(),t.ondeleted(t),!1},this.name=this.main.querySelector('span[class="name"]'),this.volume=this.main.querySelector('span[class="volume"]'),this.name.textContent=e.name,this.volume.textContent=e.quantity+" "+e.unitShortName},ListIngredients=function(){function e(e,t,n){void 0===t&&(t=!1),void 0===n&&(n="listIngredient");var r=this;this.addIngredient=function(t){var e=r.models.filter(function(e){return e.id===t.id});if(null!=e&&0!==e.length){var n=r.models.lastIndexOf(e[0]);r.views[n].delete()}var i=r.models.length;r.models[i]=t,r.addView()(r.models[i],i,r.models)},this.headNode=e,this.storage=t?sessionStorage:localStorage,this.key=n,this.views=new Array,this.models=JSON.parse(this.storage.getItem(this.key)),null==this.models?this.models=new Array:this.models.forEach(this.addView()),window.addEventListener("unload",function(){r.storage.setItem(r.key,JSON.stringify(r.models))}),this.headNode.onsubmit=function(){return!1}}return e.prototype.getIngredients=function(){return this.models},e.prototype.addView=function(){var n=this;return function(e,t){n.views[t]=new IngredientView(e),n.views[t].ondeleted=function(e){var t=n.views.lastIndexOf(e);n.models.splice(t,1),n.views.splice(t,1)},n.headNode.appendChild(n.views[t].main)}},e}(),IngredientAddatorView=function(){var r=this;this.name=document.querySelector('article.inventory input[type="text"]'),this.btnAdd=document.getElementById("buttonAddIngridient"),this.count=document.querySelector('article.inventory input[type="number"]'),this.unit=document.querySelector('article.inventory input[name="ingredient_unit"]'),this.form=document.querySelector("article.inventory form.add-ingredient"),this.error=new ErrorView(this.form),this.name.addEventListener("input",function(){var e=r.name.value;if(console.log(e),0!==e.length&&!document.querySelector('option[value="'+e+'"')){var t=new XMLHttpRequest;t.open("POST","/Ingredients/Index",!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.onloadend=function(){if(404!==t.status){var e=document.querySelector('datalist[id="ingredients"');null!=e&&e.parentNode.removeChild(e),r.form.insertAdjacentHTML("afterend",t.response)}},t.send("nameChip="+encodeURIComponent(e))}}),this.name.addEventListener("change",function(){var e=r.name.value,t=document.querySelector('option[value="'+e+'"');r.unit.value=null==t?null:t.getAttribute("label")}),this.form.onsubmit=function(e){r.name.setCustomValidity("");try{if(""===r.unit.value)return r.error.display("Такого ингредиента не существует"),!1;r.error.display(!1);var t=new XMLHttpRequest;t.open("POST","/IngredientQuant/FindName",!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.onloadend=function(){var e=JSON.parse(t.response);null==e.message?(r.onadded(e),r.count.value=null,r.name.value=null,r.unit.value=null):r.error.display(e.message)};var n=r.name.value,i=r.count.value;t.send("ingredientName="+encodeURIComponent(n)+"&volume="+encodeURIComponent(i))}catch(e){return console.log(e.toString()),!1}return!1}},Inventory=function(){function e(e){void 0===e&&(e=!1),this.addator=new IngredientAddatorView,this.listIngridients=new ListIngredients(document.querySelector("article.inventory form.list-ingredients"),e),this.addator.onadded=this.listIngridients.addIngredient}return e.prototype.getIngredients=function(){return this.listIngridients.getIngredients()},e}(),ListRecipesButton=function(e){var t=this;this.btn=e,"currentPage"!==this.btn.id&&(this.btn.onclick=function(e){t.onclick(parseInt(t.btn.textContent))})},ListRecipes=function(){function e(e){this.headNode=e}return e.prototype.setList=function(e,t){for(;this.headNode.hasChildNodes();)this.headNode.removeChild(this.headNode.firstChild);this.headNode.insertAdjacentHTML("beforeend",e),this.headNode.querySelectorAll(".page").forEach(function(e){new ListRecipesButton(e).onclick=function(e){t.search(e)}}),this.headNode.querySelectorAll("img").forEach(function(e){e.addEventListener("error",function(){e.src="/images/default.png"})})},e}(),TimeRecipeModel=function(e,t,n){this.days=e,this.hours=t,this.minutes=n},TimeRecipeView=function(){function e(e){this.days=e.querySelector('[name="days"]'),this.hours=e.querySelector('[name="hours"]'),this.minutes=e.querySelector('[name="minutes"]')}return e.prototype.getTime=function(){return new TimeRecipeModel(this.days.valueAsNumber,this.hours.valueAsNumber,this.minutes.valueAsNumber)},e}(),RecipeModel=function(){},RecipeCreateView=function(){function e(e,t,n){var i=this;this.name=document.getElementById("Name"),this.description=document.getElementById("Description"),this.instruction=document.getElementById("Instruction"),this.image=document.getElementById("Image");var r=new ImageView(document.getElementById("ImageOut"));this.error=new ErrorView(e),this.image.addEventListener("change",function(e){r.setLink(i.image.value)});new ImageUploader(this.image,function(e){i.image.value=e,r.setLink(e)});this.cookingTime=new TimeRecipeView(e.querySelector('[name="time"]')),this.ingredients=t,e.onsubmit=function(){try{var e=new RecipeModel;for(var t in i)"ingredients"==t?(e.ingredients=i.ingredients.getIngredients(),console.debug(i.ingredients.getIngredients())):"cookingTime"==t?e.cookingTime=i.cookingTime.getTime():"error"!=t&&"setError"!=t&&(e[t.toString()]=i[t.toString()].value);n(e)}catch(e){console.log(e)}return!1}}return e.prototype.setError=function(e){this.error.display(e)},e}(),SearcherByStringView=function(e){var n=this;this.form=e,this.data=this.form.querySelector('input[name="searchString"]'),this.form.onsubmit=function(){var e=n.data.value;if(e){var t=new SearcherByString(e);n.onsearch(t)}return!1}},SearcherByString=function(){function e(e){this.request=e.slice()}return e.prototype.search=function(e){var t=this;if("number"==typeof e){var n=e,i=new XMLHttpRequest;i.onloadend=function(){404!==i.status?t.onsearched(i.response,t):console.log('По запросу "'+t.request+'" ответ: 404')},i.open("POST","/Recipes/SearchByString",!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send("searchString="+encodeURIComponent(this.request)+"&pageNumber="+n)}else this.onsearched=e,this.search(1)},e}(),SearchByIngredientsView=function(e,t){var n=this;this.button=e,this.data=t,this.button.onclick=function(){var e=n.data.getIngredients();if(e){var t=new SearcherByIngredients(e);n.onsearch(t)}return!1}},SearcherByIngredients=function(){function e(e){this.request=e.slice()}return e.prototype.search=function(e){var t=this;if("number"==typeof e){var n=e,i=new XMLHttpRequest;i.onloadend=function(){404!==i.status?t.onsearched(i.response,t):console.log('По запросу "'+t.request+'" ответ: 404')},i.open("POST","/Recipes/SearchByIngredients",!0),i.setRequestHeader("Content-Type","application/json");var r={ingredients:this.request,pageNumber:n};i.send(JSON.stringify(r))}else this.onsearched=e,this.search(1)},e}();